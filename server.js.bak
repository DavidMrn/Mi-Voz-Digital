require('dotenv').config();


const express = require('express');
const cors = require('cors');
const fs = require('fs').promises;
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3000;


const mongoose = require('mongoose');

mongoose.connect(process.env.MONGO_URI)
    .then(() => console.log("MongoDB conectado"))
    .catch(err => console.log("Error en MongoDB:", err));

    
// Middleware
app.use(cors());
app.use(express.json({ limit: '50mb' }));
app.use(express.static('public'));

// Archivos de datos
const DATA_DIR = path.join(__dirname, 'data');
const REPORTES_FILE = path.join(DATA_DIR, 'reportes.json');
const PROPUESTAS_FILE = path.join(DATA_DIR, 'propuestas.json');
const USUARIOS_FILE = path.join(DATA_DIR, 'usuarios.json');

// Crear directorio de datos si no existe
async function initializeData() {
    try {
        await fs.mkdir(DATA_DIR, { recursive: true });
        
        // Inicializar archivos si no existen
        try {
            await fs.access(REPORTES_FILE);
        } catch {
            await fs.writeFile(REPORTES_FILE, JSON.stringify([]));
        }
        
        try {
            await fs.access(PROPUESTAS_FILE);
        } catch {
            await fs.writeFile(PROPUESTAS_FILE, JSON.stringify([]));
        }

        try {
            await fs.access(USUARIOS_FILE);
        } catch {
            await fs.writeFile(USUARIOS_FILE, JSON.stringify([]));
        }
    } catch (error) {
        console.error('Error inicializando datos:', error);
    }
}

// Funciones auxiliares para leer/escribir datos
async function leerDatos(archivo) {
    try {
        const data = await fs.readFile(archivo, 'utf8');
        return JSON.parse(data);
    } catch (error) {
        console.error('Error leyendo datos:', error);
        return [];
    }
}

async function escribirDatos(archivo, datos) {
    try {
        await fs.writeFile(archivo, JSON.stringify(datos, null, 2));
        return true;
    } catch (error) {
        console.error('Error escribiendo datos:', error);
        return false;
    }
}

// ============= RUTAS DE AUTENTICACI√ìN CIUDADANOS =============

// Registrar nuevo ciudadano
app.post('/api/auth/registrar', async (req, res) => {
    try {
        const { nombre, usuario, password } = req.body;
        
        // Validaciones b√°sicas
        if (!nombre || !usuario || !password) {
            return res.status(400).json({ error: 'Faltan campos requeridos' });
        }
        
        if (password.length < 6) {
            return res.status(400).json({ error: 'La contrase√±a debe tener al menos 6 caracteres' });
        }
        
        const usuarios = await leerDatos(USUARIOS_FILE);
        
        // Verificar si usuario ya existe
        if (usuarios.find(u => u.usuario === usuario)) {
            return res.status(409).json({ error: 'El usuario ya est√° registrado' });
        }
        
        // Crear nuevo usuario
        const nuevoUsuario = {
            id: Date.now().toString(),
            nombre: nombre,
            usuario: usuario,
            password: password,
            fechaRegistro: new Date().toISOString()
        };
        
        usuarios.push(nuevoUsuario);
        
        if (await escribirDatos(USUARIOS_FILE, usuarios)) {
            res.status(201).json({ 
                message: 'Usuario registrado exitosamente',
                usuario: { id: nuevoUsuario.id, nombre: nuevoUsuario.nombre, usuario: nuevoUsuario.usuario }
            });
        } else {
            res.status(500).json({ error: 'Error al guardar usuario' });
        }
    } catch (error) {
        res.status(500).json({ error: 'Error al registrar usuario' });
    }
});

// Login ciudadano
app.post('/api/auth/login', async (req, res) => {
    try {
        const { usuario, password } = req.body;
        
        if (!usuario || !password) {
            return res.status(400).json({ error: 'Faltan usuario o contrase√±a' });
        }
        
        const usuarios = await leerDatos(USUARIOS_FILE);
        const usuarioEncontrado = usuarios.find(u => u.usuario === usuario && u.password === password);
        
        if (usuarioEncontrado) {
            res.json({
                message: 'Login exitoso',
                usuario: {
                    id: usuarioEncontrado.id,
                    nombre: usuarioEncontrado.nombre,
                    usuario: usuarioEncontrado.usuario
                }
            });
        } else {
            res.status(401).json({ error: 'Usuario o contrase√±a incorrectos' });
        }
    } catch (error) {
        res.status(500).json({ error: 'Error al iniciar sesi√≥n' });
    }
});

// ============= RUTAS DE REPORTES =============

// Obtener todos los reportes
app.get('/api/reportes', async (req, res) => {
    try {
        const reportes = await leerDatos(REPORTES_FILE);
        res.json(reportes);
    } catch (error) {
        res.status(500).json({ error: 'Error al obtener reportes' });
    }
});

// Obtener un reporte espec√≠fico
app.get('/api/reportes/:id', async (req, res) => {
    try {
        const reportes = await leerDatos(REPORTES_FILE);
        const reporte = reportes.find(r => r.id === req.params.id);
        
        if (reporte) {
            res.json(reporte);
        } else {
            res.status(404).json({ error: 'Reporte no encontrado' });
        }
    } catch (error) {
        res.status(500).json({ error: 'Error al obtener reporte' });
    }
});

// Crear nuevo reporte
app.post('/api/reportes', async (req, res) => {
    try {
        const reportes = await leerDatos(REPORTES_FILE);
        
        const nuevoReporte = {
            id: `REP-${Date.now()}`,
            ...req.body,
            fecha: new Date().toISOString(),
            votos: 0,
            estado: 'pendiente'
        };
        
        reportes.push(nuevoReporte);
        
        if (await escribirDatos(REPORTES_FILE, reportes)) {
            res.status(201).json(nuevoReporte);
        } else {
            res.status(500).json({ error: 'Error al guardar reporte' });
        }
    } catch (error) {
        res.status(500).json({ error: 'Error al crear reporte' });
    }
});

// Votar por un reporte
app.post('/api/reportes/:id/votar', async (req, res) => {
    try {
        const reportes = await leerDatos(REPORTES_FILE);
        const index = reportes.findIndex(r => r.id === req.params.id);
        
        if (index !== -1) {
            reportes[index].votos += 1;
            
            if (await escribirDatos(REPORTES_FILE, reportes)) {
                res.json(reportes[index]);
            } else {
                res.status(500).json({ error: 'Error al guardar voto' });
            }
        } else {
            res.status(404).json({ error: 'Reporte no encontrado' });
        }
    } catch (error) {
        res.status(500).json({ error: 'Error al votar' });
    }
});

// Cambiar estado de un reporte (L√≠der)
app.put('/api/reportes/:id/estado', async (req, res) => {
    try {
        const reportes = await leerDatos(REPORTES_FILE);
        const index = reportes.findIndex(r => r.id === req.params.id);
        
        if (index !== -1) {
            reportes[index].estado = req.body.estado;
            reportes[index].fechaActualizacion = new Date().toISOString();
            
            if (await escribirDatos(REPORTES_FILE, reportes)) {
                res.json(reportes[index]);
            } else {
                res.status(500).json({ error: 'Error al actualizar estado' });
            }
        } else {
            res.status(404).json({ error: 'Reporte no encontrado' });
        }
    } catch (error) {
        res.status(500).json({ error: 'Error al cambiar estado' });
    }
});

// ============= RUTAS DE PROPUESTAS =============

// Obtener todas las propuestas
app.get('/api/propuestas', async (req, res) => {
    try {
        const propuestas = await leerDatos(PROPUESTAS_FILE);
        res.json(propuestas);
    } catch (error) {
        res.status(500).json({ error: 'Error al obtener propuestas' });
    }
});

// Obtener una propuesta espec√≠fica
app.get('/api/propuestas/:id', async (req, res) => {
    try {
        const propuestas = await leerDatos(PROPUESTAS_FILE);
        const propuesta = propuestas.find(p => p.id === req.params.id);
        
        if (propuesta) {
            res.json(propuesta);
        } else {
            res.status(404).json({ error: 'Propuesta no encontrada' });
        }
    } catch (error) {
        res.status(500).json({ error: 'Error al obtener propuesta' });
    }
});

// Crear nueva propuesta
app.post('/api/propuestas', async (req, res) => {
    try {
        const propuestas = await leerDatos(PROPUESTAS_FILE);
        
        const nuevaPropuesta = {
            id: `PROP-${Date.now()}`,
            ...req.body,
            fecha: new Date().toISOString(),
            votos: 0,
            estado: 'pendiente'
        };
        
        propuestas.push(nuevaPropuesta);
        
        if (await escribirDatos(PROPUESTAS_FILE, propuestas)) {
            res.status(201).json(nuevaPropuesta);
        } else {
            res.status(500).json({ error: 'Error al guardar propuesta' });
        }
    } catch (error) {
        res.status(500).json({ error: 'Error al crear propuesta' });
    }
});

// Votar por una propuesta
app.post('/api/propuestas/:id/votar', async (req, res) => {
    try {
        const propuestas = await leerDatos(PROPUESTAS_FILE);
        const index = propuestas.findIndex(p => p.id === req.params.id);
        
        if (index !== -1) {
            propuestas[index].votos += 1;
            
            if (await escribirDatos(PROPUESTAS_FILE, propuestas)) {
                res.json(propuestas[index]);
            } else {
                res.status(500).json({ error: 'Error al guardar voto' });
            }
        } else {
            res.status(404).json({ error: 'Propuesta no encontrada' });
        }
    } catch (error) {
        res.status(500).json({ error: 'Error al votar' });
    }
});

// Cambiar estado de una propuesta (L√≠der)
app.put('/api/propuestas/:id/estado', async (req, res) => {
    try {
        const propuestas = await leerDatos(PROPUESTAS_FILE);
        const index = propuestas.findIndex(p => p.id === req.params.id);
        
        if (index !== -1) {
            propuestas[index].estado = req.body.estado;
            propuestas[index].fechaActualizacion = new Date().toISOString();
            
            if (await escribirDatos(PROPUESTAS_FILE, propuestas)) {
                res.json(propuestas[index]);
            } else {
                res.status(500).json({ error: 'Error al actualizar estado' });
            }
        } else {
            res.status(404).json({ error: 'Propuesta no encontrada' });
        }
    } catch (error) {
        res.status(500).json({ error: 'Error al cambiar estado' });
    }
});

// ============= ESTAD√çSTICAS =============

app.get('/api/estadisticas', async (req, res) => {
    try {
        const reportes = await leerDatos(REPORTES_FILE);
        const propuestas = await leerDatos(PROPUESTAS_FILE);
        
        const estadisticas = {
            totalReportes: reportes.length,
            totalPropuestas: propuestas.length,
            reportesPendientes: reportes.filter(r => r.estado === 'pendiente').length,
            reportesEnProceso: reportes.filter(r => r.estado === 'en-proceso').length,
            reportesResueltos: reportes.filter(r => r.estado === 'resuelto').length,
            propuestasPendientes: propuestas.filter(p => p.estado === 'pendiente').length,
            propuestasEnProceso: propuestas.filter(p => p.estado === 'en-proceso').length,
            propuestasResueltas: propuestas.filter(p => p.estado === 'resuelto').length,
            totalVotos: reportes.reduce((sum, r) => sum + r.votos, 0) + 
                       propuestas.reduce((sum, p) => sum + p.votos, 0)
        };
        
        res.json(estadisticas);
    } catch (error) {
        res.status(500).json({ error: 'Error al obtener estad√≠sticas' });
    }
});

// Ruta ra√≠z
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// Inicializar y arrancar servidor
initializeData().then(() => {
    app.listen(PORT, () => {
        console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                       ‚ïë
‚ïë      üèõÔ∏è  MI VOZ DIGITAL - SERVIDOR ACTIVO üèõÔ∏è         ‚ïë
‚ïë                                                       ‚ïë
‚ïë      Servidor corriendo en: http://localhost:${PORT}   ‚ïë
‚ïë                                                       ‚ïë
‚ïë      Endpoints disponibles:                          ‚ïë
‚ïë      - GET    /api/reportes                          ‚ïë
‚ïë      - POST   /api/reportes                          ‚ïë
‚ïë      - POST   /api/reportes/:id/votar                ‚ïë
‚ïë      - PUT    /api/reportes/:id/estado               ‚ïë
‚ïë      - GET    /api/propuestas                        ‚ïë
‚ïë      - POST   /api/propuestas                        ‚ïë
‚ïë      - POST   /api/propuestas/:id/votar              ‚ïë
‚ïë      - PUT    /api/propuestas/:id/estado             ‚ïë
‚ïë      - GET    /api/estadisticas                      ‚ïë
‚ïë                                                       ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        `);
    });
});

// Manejo de errores
process.on('uncaughtException', (error) => {
    console.error('Error no capturado:', error);
});

process.on('unhandledRejection', (reason, promise) => {
    console.error('Promesa rechazada no manejada:', reason);
});